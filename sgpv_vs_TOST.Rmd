---
title: "Equivalence Testing and the Second Generation P-Value"
author: "DaniÃ«l Lakens & Marie Delacre"
date: "1 juli 2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r, include=FALSE}
library(TOSTER)
```


```{r, include=FALSE}
#Create SGPV funtion from https://github.com/LucyMcGowan/sgpvalue/blob/master/R/p_delta.R

#' Second Generation P-value
p_delta <- function(lb, ub, delta_lb, delta_ub) {
  
  # special case: infinite CI and H0 bounds in the same direction
  if ((delta_lb == -Inf & lb == -Inf) | (delta_ub == Inf & ub == Inf)) {
    return(1)
  }
  
  # usual case: non-point CI & non-point Ho
  # pdelta = |CI intersect Ho| / min{ |CI|, 2|Ho| }
  if (delta_lb != delta_ub & lb != ub) {
    if (lb > delta_ub | ub < delta_lb) {
      return(0)
    } else if(lb > delta_lb & ub < delta_ub){
      return(1)
    } else {
      return(
        (min(ub, delta_ub) - max(lb, delta_lb)) /
          min(ub - lb, 2 * (delta_ub - delta_lb))
      )
    }
  }
  
  # special case 1: point CI, w/ or w/out a point H0
  # pdelta = 0 if CI is inside the Ho
  # pdelta = 1 if CI is inside the Ho
  if (lb == ub) {
    if (lb <= delta_ub & lb >= delta_lb){
      return(1)
    } else {
      return(0)
    }
  }
  
  # special case 2: point H0 & non-point CI
  # pdelta = 1/2 if H0 is inside the CI
  # pdelta = 0 if H0 is outside the CI
  if (delta_lb == delta_ub & lb != ub) {
    if (delta_lb <= ub & delta_lb >= lb) {
      return(1/2)
    } else {
      return(0)
    }
  }
}

#Code to calculate SGPV fron TOST results
# Input parameters
# res = the stored results from the TOST analysis
# n is the sample size
# sd is the standard deviation
#-----------------------------------------------------------------------
TOST_to_SGPV <- function(tost_res){
  
  # computing t, based on p_tost
  t <- min(tost_res$TOST_t1, tost_res$TOST_t2) 
  
  n <- tost_res$TOST_df + 1
  sd <- (tost_res$diff-tost_res$low_eqbound)/tost_res$TOST_t1 * sqrt(n)
  
  # computing I
  dist <- t * sd/sqrt(n) # how far is I from the closest eqbound?
  
  #LAKENS: I I fixed this now - you can't know based on non-sig if bound is left or right from alpha. 
  #It should be based on whether p is larger or smaller than 0.5. I smaller than 0.5, bound - dist. 
  if (tost_res$TOST_p1 > tost_res$TOST_p2) {
    if (tost_res$TOST_p1 < 0.5){I = tost_res$low_eqbound + dist}
    if (tost_res$TOST_p1 > 0.5){I = tost_res$low_eqbound - dist}} 
  
  if (tost_res$TOST_p2 > tost_res$TOST_p1) {
    if (tost_res$TOST_p2 < 0.5){I = tost_res$low_eqbound - dist}
    if (tost_res$TOST_p2 > 0.5){I = tost_res$low_eqbound + dist}} 
  
  # Computing the CI around I
  lb <- I - qt(1 - tost_res$alpha/2, df = n - 1) * sd/sqrt(n) # lower bound
  ub <- I + qt(1 - tost_res$alpha/2, df = n - 1) * sd/sqrt(n) # upper bound
  
  if (lb > tost_res$high_eqbound | ub < tost_res$low_eqbound){
    SGPV = 0
    } 
  else if(lb > tost_res$low_eqbound & ub < tost_res$high_eqbound){
    SGPV = 1
    } 
  else {SGPV <- (min(ub, tost_res$high_eqbound) - max(lb, tost_res$low_eqbound))/min(ub - lb, 2 * (tost_res$high_eqbound - tost_res$low_eqbound))}
  
  return(SGPV)
}

```

The second generation p-value (SGPV) is the proportion of data-supported hypotheses that are also null hypotheses (Blume, McGowan, Dupont, & Greevy, (2018). The authors note that: "Using second-generation p-values can only improve rigor, reproducibility and transparency across science." 
It was quickly noted on Twitter that the SGPV is similar to equivalence testing (https://twitter.com/statsepi/status/997759878503550976, https://twitter.com/lakens/status/995171827692515328). 

In the plot below I calculate p-values for the TOST equivalence testing procedure, and plot the SGPV for the same tests:

```{r, include=FALSE}
step = 0.01

p_tost_list <- numeric(length(seq(140, 146, step)))
sgpv_list <- numeric(length(seq(140, 146, step)))
p_list <- numeric(length(seq(140, 146, step)))
t_list <- numeric(length(seq(140, 146, step)))

count <- 0

for(i in seq(140, 146, step)){
  count <- count + 1
  m <- i
  mu <- 146
  sd <- 800
  n <- 1000000
  low_eqbound = -2 
  high_eqbound = 2 
  alpha = 0.05
   
  invisible(capture.output(res <- TOSTone.raw(m = m, 
                                              mu = mu,
                                              sd = sd, 
                                              n = n, 
                                              low_eqbound = low_eqbound, 
                                              high_eqbound = high_eqbound, 
                                              alpha = alpha,
                                              plot = FALSE
  )))
  t <- (m - mu)/(sd/sqrt(n))
  t_list[count] <- t
  sgpv_list[count] <- p_delta(mu+res$LL_CI_TTEST, mu+res$UL_CI_TTEST, mu+low_eqbound, mu+high_eqbound)
  p_tost_list[count] <- max(res$TOST_p1, res$TOST_p2)
  p_list[count] <- 2 * pt(-abs(t), df = n-1)
}
```

```{r sgpv_tost, echo=FALSE}
plot(sgpv_list, type="l", col = "blue")
lines(p_tost_list)
```

For ease of comparison, let me repeat the plot, now showing 1-TOST p-values:

```{r 1-sgpv_tost, echo=FALSE}
plot(sgpv_list, type="l", col = "blue")
lines(1-p_tost_list)
```

It is clear there is overlap. Some orientation in this plot. When the TOST p-value is 0.5, the SGPV is 0.5. This is because when the 95% CI overlaps 50% with the equivalence region, it falls exactly on the lowerbound. When this is the case, the probability of observing data as or more extreme as the data observed is also exactly 50%, and thus the TOST p-value is 0.5 as well. 

Two other points always have to overlap. When the 95% CI falls completely inside the equivalence region, The TOST using a 95% (instead of the typical 90% CI) should be significant at the 5% level. Since TOST in this simulation uses a 90% CI, we can halve the alpha level, and thus we should expect that when the SGPV is is 1, and the 95% just touches the lower bound (around index 558) the TOST p-value is 2.5% (or 1-0.025=0.975 in the second plot). The opposite is also true: When the SGPV is changes from 0 to a positive value (around index 245) the 95% CI touches the outside of the lower bound, and the TOST p-value will be 0.975 (or in the lower plot showing 1-p_TOST, 0.025). 

We can see SGPV is a straight line between these points, because each trial, the observed difference moves from m = 140 to 146 in steps of 0.01. When m = 146, there is perfect equivalence (since we are testing against a value of 146 in the one-sided test).

The only thing we need to explain is why the TOST p-value is curved, where the SGPV is a straight line as we reduce the mean difference with 0.01 steps as the index increases. The difference is that SGPV is a proportion from 0 to 1 (with it being 0 when there is no overlap, and 1 if there is perfect overlap) while the TOST p-value is a probability, which is never exactly 0 or one (but can get really close).

Let's look at an example, and write in full the calculation for the SGPV. We should be able to link it to the calculation for the TOST p-value.

```{r}
m <- 146
mu <- 144.5
sd <- 500
n <- 1000000
low_eqbound = -2 
high_eqbound = 2 
alpha = 0.05

tost_res <- TOSTone.raw(m = m, 
                   mu = mu,
                   sd = sd, 
                   n = n, 
                   low_eqbound = low_eqbound, 
                   high_eqbound = high_eqbound, 
                   alpha = alpha
)


TOST_to_SGPV(tost_res = tost_res)


```

The confidence interval width is a uniformly distributed across the mean differences, in the sense that as the true mean in a one-sample t-test gets closer to the test value (in the plot below, from situation A to D, the mean gets closer to the test value by 0.1) the difference in the overlap is stable.

```{r}
m <- 146
mu <- 144.5
sd <- 500
n <- 1000000
low_eqbound = -2 
high_eqbound = 2 
alpha = 0.05

tost_res1 <- TOSTone.raw(m = m, 
                   mu = mu,
                   sd = sd, 
                   n = n, 
                   low_eqbound = low_eqbound, 
                   high_eqbound = high_eqbound, 
                   alpha = alpha
)
SGPV1 <- TOST_to_SGPV(tost_res = tost_res1)

m <- 145.9
mu <- 144.5
sd <- 500
n <- 1000000
low_eqbound = -2 
high_eqbound = 2 
alpha = 0.05

tost_res2 <- TOSTone.raw(m = m, 
                   mu = mu,
                   sd = sd, 
                   n = n, 
                   low_eqbound = low_eqbound, 
                   high_eqbound = high_eqbound, 
                   alpha = alpha
)
SGPV2 <- TOST_to_SGPV(tost_res = tost_res2)

m <- 145.8
mu <- 144.5
sd <- 500
n <- 1000000
low_eqbound = -2 
high_eqbound = 2 
alpha = 0.05

tost_res3 <- TOSTone.raw(m = m, 
                   mu = mu,
                   sd = sd, 
                   n = n, 
                   low_eqbound = low_eqbound, 
                   high_eqbound = high_eqbound, 
                   alpha = alpha
)
SGPV3 <- TOST_to_SGPV(tost_res = tost_res3)

m <- 145.7
mu <- 144.5
sd <- 500
n <- 1000000
low_eqbound = -2 
high_eqbound = 2 
alpha = 0.05

tost_res4 <- TOSTone.raw(m = m, 
                   mu = mu,
                   sd = sd, 
                   n = n, 
                   low_eqbound = low_eqbound, 
                   high_eqbound = high_eqbound, 
                   alpha = alpha
)
SGPV4 <- TOST_to_SGPV(tost_res = tost_res4)

0.7551064 - 0.7040851
0.6530639 - 0.6020426



plot(NA, 
     ylim = c(0, 1), 
     xlim = c(-3, 3),
     yaxt = "n",
     ylab = "",
     xlab = "Mean Difference")
axis(2, at = c(0.2,0.4,0.6,0.8), labels = c("D", "C", "B", "A"), las = 1)
abline(v = tost_res1$high_eqbound, 
       lty = 2)
abline(v = tost_res1$low_eqbound, 
       lty = 2)
abline(v = 0, 
       lty = 2, 
       col = "grey")

points(x = tost_res4$diff, 
       y = 0.2, 
       pch = 15, 
       cex = 2)
segments(tost_res4$LL_CI_TOST, 
         0.2, 
         tost_res4$UL_CI_TOST, 
         0.2, 
         lwd = 3)


points(x = tost_res3$diff, 
       y = 0.4, 
       pch = 15, 
       cex = 2)
segments(tost_res3$LL_CI_TOST, 
         0.4, 
         tost_res3$UL_CI_TOST, 
         0.4, 
         lwd = 3)

points(x = tost_res2$diff, 
       y = 0.6, 
       pch = 15, 
       cex = 2)
segments(tost_res2$LL_CI_TOST, 
         0.6, 
         tost_res2$UL_CI_TOST, 
         0.6, 
         lwd = 3)

points(x = tost_res1$diff, 
       y = 0.8, 
       pch = 15, 
       cex = 2)
segments(tost_res1$LL_CI_TOST, 
         0.8, 
         tost_res1$UL_CI_TOST, 
         0.8, 
         lwd = 3)



```

For example, the SGPV from A to D is `r SGPV1`, `r SGPV2`, `r SGPV3`, and `r SGPV4`. The difference in the percentage of overlap between A and B (`r SGPV1-SGPV2`) is identical to the difference in the percentage of overlap between C and D as the mean gets 0.1 closer to the test value (`r SGPV3-SGPV4`). 


#References

Blume, J. D., McGowan, L. D., Dupont, W. D., & Greevy, R. A. (2018). Second-generation p-values: Improved rigor, reproducibility, & transparency in statistical analyses. PLOS ONE, 13(3), e0188299. https://doi.org/10.1371/journal.pone.0188299


